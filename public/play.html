<!DOCTYPE html>
<html style="height: 100%; background-color:grey">
<header>
    <script src="https://code.jquery.com/jquery-3.5.1.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.css"  crossorigin="anonymous">
    <link rel="stylesheet" href="/css/play.css">
    <link href='https://css.gg/stopwatch.css' rel='stylesheet'>
</header>
<body>
    <div style="display: flex; justify-content:space-around; flex-wrap: wrap; height: 100%;">
        <div style="display: flex; flex-direction: column; align-items: center; margin-top: 50px;">
            <div style="width: 130px; height: 80px; display: flex; justify-content: center;">
                <i class="gg-stopwatch" style=" transform: scale(var(--ggs,3)); width: 30px; height: 30px;"></i>
            </div>
            <label style="background-color: rgb(255, 255, 255); border-width: 3px; border-style:ridge; border-color: rgb(255, 255, 255);">
                <label id="timerSec1" class="timerLabel"></label>:<label id="timerSec2" class="timerLabel"></label>:<label id="timerSec3" class="timerLabel"></label>
            </label>
            
        </div>
        
        <div style="width: 40%; position: relative;">
            <div id="myBoard" style="width: 100%"></div>
             <div id="promotionPopup"></div>
        </div>
        <div style="width: 15%;display: flex; justify-content: center; flex-wrap: wrap;">
            <div id="pgnContainer"></div>
            <section><button class="button" onclick="giveUp()">Give Up</button><button class="button" onclick="nextPuzzle()">Next</button></section>
        </div>
        
    </div>
    
      
    <img src="img/chesspieces/wikipedia/wP.png" id="695f-6e79-ab1c-a5cc-a26f-4b18-88d5-0388" alt="" class="piece-417db" data-piece="wP" style="width: 49px; height: 49px; display: none;">
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js" crossorigin="anonymous"></script>   
    <script src="javascript/board_setup.js"></script>
    <script src="javascript/gameVariations.js"></script>
    <script src="javascript/timer.js"></script>
    <script>
        let boardState = null
        let board = null
        let game = null
        let gameData = null
        const startGame = async function startGame(){

            const getGameData = async function fetchGameData(){
                const gameData = await fetch('/play/game_data')
                if(gameData.status=='200'){
                   return await gameData.json()
                }
            }
            gameData = await getGameData()
            const continuation = gameData.continuation.split(" ")

            board = Chessboard('myBoard');
            game = new Chess(gameData.fen);
            let variation = new Variation(0, game.fen())
            boardState={
                currentVariation:variation,
                mainVariation:variation,
                currentPly:0,
                variations:[variation],
                progress:"Solving",
                promotionInProgress:false,
                promotionMove: null

            }
            const promote = function promote(elem){
                const type =  this.getAttribute('type')
                let div = document.getElementById('promotionPopup')
                div.innerHTML = ""
                div.style = "display: none;"
                let move = boardState.promotionMove
                move.promotion = type
                move = addMove(move,game, boardState)
                updateScoreSheet(boardState,move, game)
                updateProgress(boardState, continuation,move)
                boardSetUp(board, game, continuation, boardState, displayPromotionPopup)
            }
            const displayPromotionPopup = function displayPromotionPopup(white, fileNumber, rank){
                const peiceImageNames = ['wQ.png','wN.png','wR.png','wB.png', 'bQ.png', 'bN.png','bR.png','bB.png']
                const pieceTypes = ['q','n','r','b']
                for(let i=0; i<4; i++){
                    let peiceButton = document.createElement('button')
                    peiceButton.onclick = promote
                    peiceButton.setAttribute('type',pieceTypes[i])
                    peiceButton.style="width: fit-content; height: fit-content;"
                    let image = document.createElement('img')
                    let index=i
                    if(!white)index+=4
                    image.setAttribute('src',"img/chesspieces/wikipedia/"+peiceImageNames[index])
                    image.style="width: 100%;"
                    peiceButton.appendChild(image)
                    
                    let div = document.getElementById('promotionPopup')
                    div.appendChild(peiceButton)
                    div.style="width: 12.5%; height:200px;position: absolute; z-index: 1; top:0; left:"+fileNumber*50
                }
                
            }
            
            boardSetUp(board, game, continuation, boardState, displayPromotionPopup);
            countdown(10000, 10)
        }
        const giveUp = function giveUp(){
            window.loction.href='http://localhost:7500/search_puzzles.html'
        }
        startGame()
        
        
    </script>
</body>
</html>